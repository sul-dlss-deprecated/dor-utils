#!/usr/bin/env ruby
require File.expand_path(File.dirname(__FILE__) + '/../config/boot')

class ObjectMerge

  def initialize
    @logger = Logger.new STDOUT
  end

  # assumes ARGV.first is path to CSV file of objects to merge
  def merge_csv
    @csv = CSV.read ARGV.first
    @csv.each do |row|
      merge_row row
    end
  end

  def merge_row row
    ids = row.map do |id|
      if id =~ /^druid:/
        id
      else
        "druid:#{id}"
      end
    end
    primary = row.shift
    ms = MergeService.merge_into_primary primary, row, @logger
  rescue => e
    @logger "Problem trying to merge into primary #{primary} : #{e.inspect}"
    @logger e.backtrace.join "\n"
  end

end

ObjectMerge.new.merge_csv
