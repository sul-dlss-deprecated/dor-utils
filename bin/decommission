#!/usr/bin/env ruby
require_relative '../config/boot'

class Decom

  def initialize
    if(Dor::Config.decommission_log)
      log = Dor::Config.decommission_log
    else
      log = STDOUT
    end
    @logger = Logger.new log
  end

  def work
    if(ARGV.size != 2)
      puts "Usage: decomission [-e ENVIRONMENT] druids.txt \"Decomission tag\""
      exit
    end
    lines = IO.read(ARGV.shift).map {|l| l.strip}
    @druids = lines.map do |id|
      if id =~ /^druid:/
        id
      else
        "druid:#{id}"
      end
    end
    @tag = ARGV.shift

    decomission
  end

  def decomission
    @druids.each do |druid|
      begin
        obj = Dor::Item.find druid
        obj.decomission @tag
        obj.save

        DigitalStacksService.prune_stacks_dir druid
        obj.publish_metadata
        Dor::CleanupService.cleanup_by_druid druid
      rescue => e
        @logger.error "Unable to decomission #{druid} : #{e.inspect}"
        @logger.error e.backtrace.join("\n")
      end
    end
  end

end

Decom.new.work